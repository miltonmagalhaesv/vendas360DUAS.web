{
  "gitSyncId": "68750378005e0954974296b0_23df6125-d2b8-4546-bb4c-87d9852b96e3",
  "id": "Analise PDV_getResumoPDV",
  "pluginId": "postgres-plugin",
  "pluginType": "DB",
  "unpublishedAction": {
    "actionConfiguration": {
      "body": "WITH base AS (\n  SELECT\n    nome_loja,\n    nome_vendedor,\n    COALESCE(meta_valor,    0)::numeric AS meta_valor,\n    COALESCE(valor_vendido, 0)::numeric AS valor_vendido\n  FROM public.vw_comissao_vendedores_completa\n  WHERE mes_ano = '{{ selMesAno.selectedOptionValue }}'::date\n),\nagg AS (\n  SELECT\n    nome_loja,\n    SUM(meta_valor)                    AS total_meta_pdv,\n    SUM(valor_vendido)                 AS total_vendido_pdv,\n    COUNT(DISTINCT nome_vendedor)      AS n_vendedores\n  FROM base\n  GROUP BY 1\n),\ntot_empresa AS (\n  SELECT SUM(total_vendido_pdv) AS total_vendido_empresa\n  FROM agg\n)\nSELECT\n  a.nome_loja,\n  ROUND(a.total_meta_pdv, 2)                               AS total_meta_pdv,\n  ROUND(a.total_vendido_pdv, 2)                            AS total_vendido_pdv,\n  ROUND(GREATEST(a.total_meta_pdv - a.total_vendido_pdv, 0), 2) AS gap_meta_pdv,\n  a.n_vendedores,\n  -- Atingimento do PDV (ponderado corretamente)\n  ROUND(\n    CASE WHEN a.total_meta_pdv > 0\n         THEN (a.total_vendido_pdv / a.total_meta_pdv) * 100\n         ELSE 0 END\n  , 2)                                                     AS atingimento_pdv_pct,\n  -- Participação do PDV no faturamento total da empresa no mês\n  ROUND(\n    CASE WHEN t.total_vendido_empresa > 0\n         THEN (a.total_vendido_pdv / t.total_vendido_empresa) * 100\n         ELSE 0 END\n  , 2)                                                     AS participacao_empresa_pct\nFROM agg a\nCROSS JOIN tot_empresa t\nORDER BY a.total_vendido_pdv DESC, a.nome_loja;",
      "encodeParamsToggle": true,
      "paginationType": "NONE",
      "pluginSpecifiedTemplates": [
        {
          "value": true
        }
      ],
      "timeoutInMillisecond": 10000
    },
    "confirmBeforeExecute": false,
    "datasource": {
      "id": "BD DUAS",
      "isAutoGenerated": false,
      "name": "BD DUAS",
      "pluginId": "postgres-plugin"
    },
    "dynamicBindingPathList": [
      {
        "key": "body"
      }
    ],
    "name": "getResumoPDV",
    "pageId": "Analise PDV",
    "runBehaviour": "AUTOMATIC",
    "userSetOnLoad": false
  }
}