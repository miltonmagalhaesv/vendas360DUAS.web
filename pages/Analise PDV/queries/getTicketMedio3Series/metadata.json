{
  "gitSyncId": "68750378005e0954974296b0_8836c9fa-c59c-4f90-8d62-e47b24a31770",
  "id": "Analise PDV_getTicketMedio3Series",
  "pluginId": "postgres-plugin",
  "pluginType": "DB",
  "unpublishedAction": {
    "actionConfiguration": {
      "body": "WITH base AS (\n  SELECT\n    data_lanca,\n    ponto_venda,\n    id_venda,\n    oper,\n    valor_liquido\n  FROM public.vw_resumo_vend_devo\n  WHERE EXTRACT(YEAR FROM data_lanca) IN (\n    {{ Number(selAno.selectedOptionValue) }},\n    {{ Number(selAno.selectedOptionValue) - 1 }}\n  )\n),\ntm_pv AS (\n  SELECT\n    EXTRACT(YEAR FROM data_lanca)                    AS ano,\n    ponto_venda,\n    date_trunc('month', data_lanca)::date            AS mes_data,\n    TO_CHAR(date_trunc('month', data_lanca), 'Mon')  AS mes_nome,\n    ROUND(\n      SUM(CASE WHEN oper = 'S - Venda' THEN valor_liquido ELSE 0 END)::numeric\n      /\n      NULLIF(COUNT(DISTINCT CASE WHEN oper = 'S - Venda' THEN id_venda END), 0)\n    , 2) AS ticket_medio\n  FROM base\n  GROUP BY 1,2,3,4\n),\ntm_all AS (\n  -- \"Geral\" (todos os PVs)\n  SELECT\n    EXTRACT(YEAR FROM data_lanca)                    AS ano,\n    '__ALL__'::text                                  AS ponto_venda,\n    date_trunc('month', data_lanca)::date            AS mes_data,\n    TO_CHAR(date_trunc('month', data_lanca), 'Mon')  AS mes_nome,\n    ROUND(\n      SUM(CASE WHEN oper = 'S - Venda' THEN valor_liquido ELSE 0 END)::numeric\n      /\n      NULLIF(COUNT(DISTINCT CASE WHEN oper = 'S - Venda' THEN id_venda END), 0)\n    , 2) AS ticket_medio\n  FROM base\n  GROUP BY 1,3,4\n)\nSELECT * FROM tm_pv\nUNION ALL\nSELECT * FROM tm_all\nORDER BY mes_data, ponto_venda, ano;",
      "encodeParamsToggle": true,
      "paginationType": "NONE",
      "pluginSpecifiedTemplates": [
        {
          "value": true
        }
      ],
      "timeoutInMillisecond": 10000
    },
    "confirmBeforeExecute": false,
    "datasource": {
      "id": "BD DUAS",
      "isAutoGenerated": false,
      "name": "BD DUAS",
      "pluginId": "postgres-plugin"
    },
    "dynamicBindingPathList": [
      {
        "key": "body"
      }
    ],
    "name": "getTicketMedio3Series",
    "pageId": "Analise PDV",
    "runBehaviour": "AUTOMATIC",
    "userSetOnLoad": false
  }
}