WITH base AS (
  SELECT
    data_lanca,
    ponto_venda,
    id_venda,
    oper,
    valor_liquido
  FROM public.vw_resumo_vend_devo
  WHERE EXTRACT(YEAR FROM data_lanca) IN (
    {{ Number(selAno.selectedOptionValue) }},
    {{ Number(selAno.selectedOptionValue) - 1 }}
  )
),
tm_pv AS (
  SELECT
    EXTRACT(YEAR FROM data_lanca)                    AS ano,
    ponto_venda,
    date_trunc('month', data_lanca)::date            AS mes_data,
    TO_CHAR(date_trunc('month', data_lanca), 'Mon')  AS mes_nome,
    ROUND(
      SUM(CASE WHEN oper = 'S - Venda' THEN valor_liquido ELSE 0 END)::numeric
      /
      NULLIF(COUNT(DISTINCT CASE WHEN oper = 'S - Venda' THEN id_venda END), 0)
    , 2) AS ticket_medio
  FROM base
  GROUP BY 1,2,3,4
),
tm_all AS (
  -- "Geral" (todos os PVs)
  SELECT
    EXTRACT(YEAR FROM data_lanca)                    AS ano,
    '__ALL__'::text                                  AS ponto_venda,
    date_trunc('month', data_lanca)::date            AS mes_data,
    TO_CHAR(date_trunc('month', data_lanca), 'Mon')  AS mes_nome,
    ROUND(
      SUM(CASE WHEN oper = 'S - Venda' THEN valor_liquido ELSE 0 END)::numeric
      /
      NULLIF(COUNT(DISTINCT CASE WHEN oper = 'S - Venda' THEN id_venda END), 0)
    , 2) AS ticket_medio
  FROM base
  GROUP BY 1,3,4
)
SELECT * FROM tm_pv
UNION ALL
SELECT * FROM tm_all
ORDER BY mes_data, ponto_venda, ano;