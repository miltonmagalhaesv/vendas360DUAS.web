{
  "gitSyncId": "68750378005e0954974296b0_c741621e-a441-4928-864c-b5d0a7637b90",
  "id": "Planejamento de Metas_qry_AtingimentoMensal",
  "pluginId": "postgres-plugin",
  "pluginType": "DB",
  "unpublishedAction": {
    "actionConfiguration": {
      "body": "WITH vendas_mensais AS (\n    SELECT\n        TO_CHAR(data_lanca, 'YYYY-MM') as mes_ano,\n        EXTRACT(MONTH FROM data_lanca) as mes,\n        (\n            COALESCE(SUM(CASE WHEN oper = 'S - Venda' THEN valor_liquido ELSE 0 END), 0) +\n            COALESCE(SUM(CASE WHEN oper = 'DS - Devolução de Venda' THEN valor_liquido ELSE 0 END), 0)\n        ) AS faturamento_liquido\n    FROM public.vw_resumo_vend_devo\n    WHERE data_lanca >= '{{ moment().startOf(\"year\").format(\"YYYY-MM-DD\") }}'\n      AND data_lanca <= '{{ moment().format(\"YYYY-MM-DD\") }}'\n      AND ponto_venda = ANY ({{ Select_Lojas.selectedOptionValues }})\n    GROUP BY mes_ano, mes\n),\nmetas_mensais AS (\n    SELECT\n        mes,\n        COALESCE(SUM(meta_valor), 0) AS meta_valor\n    FROM public.vw_metas_vendas_completo\n    WHERE ano = EXTRACT(YEAR FROM CURRENT_DATE)\n      AND nome_loja = ANY ({{ Select_Lojas.selectedOptionValues }})\n    GROUP BY mes\n)\nSELECT\n    v.mes_ano,\n    v.faturamento_liquido,\n    m.meta_valor,\n    CASE\n        WHEN m.meta_valor > 0 THEN ROUND((v.faturamento_liquido * 100 / m.meta_valor)::numeric, 2)\n        ELSE 0\n    END AS perc_atingimento\nFROM vendas_mensais v\nJOIN metas_mensais m ON v.mes = m.mes\nORDER BY v.mes_ano;\n",
      "encodeParamsToggle": true,
      "paginationType": "NONE",
      "pluginSpecifiedTemplates": [
        {
          "value": true
        }
      ],
      "timeoutInMillisecond": 10000
    },
    "confirmBeforeExecute": false,
    "datasource": {
      "id": "BD DUAS",
      "isAutoGenerated": false,
      "name": "BD DUAS",
      "pluginId": "postgres-plugin"
    },
    "dynamicBindingPathList": [
      {
        "key": "body"
      }
    ],
    "name": "qry_AtingimentoMensal",
    "pageId": "Planejamento de Metas",
    "runBehaviour": "ON_PAGE_LOAD",
    "userSetOnLoad": false
  }
}