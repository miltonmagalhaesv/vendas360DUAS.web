WITH vendas_mensais AS (
    SELECT
        TO_CHAR(data_lanca, 'YYYY-MM') as mes_ano,
        EXTRACT(MONTH FROM data_lanca) as mes,
        (
            COALESCE(SUM(CASE WHEN oper = 'S - Venda' THEN valor_liquido ELSE 0 END), 0) +
            COALESCE(SUM(CASE WHEN oper = 'DS - Devolução de Venda' THEN valor_liquido ELSE 0 END), 0)
        ) AS faturamento_liquido
    FROM public.vw_resumo_vend_devo
    WHERE data_lanca >= '{{ moment().startOf("year").format("YYYY-MM-DD") }}'
      AND data_lanca <= '{{ moment().format("YYYY-MM-DD") }}'
      AND ponto_venda = ANY ({{ Select_Lojas.selectedOptionValues }})
    GROUP BY mes_ano, mes
),
metas_mensais AS (
    SELECT
        mes,
        COALESCE(SUM(meta_valor), 0) AS meta_valor
    FROM public.vw_metas_vendas_completo
    WHERE ano = EXTRACT(YEAR FROM CURRENT_DATE)
      AND nome_loja = ANY ({{ Select_Lojas.selectedOptionValues }})
    GROUP BY mes
)
SELECT
    v.mes_ano,
    v.faturamento_liquido,
    m.meta_valor,
    CASE
        WHEN m.meta_valor > 0 THEN ROUND((v.faturamento_liquido * 100 / m.meta_valor)::numeric, 2)
        ELSE 0
    END AS perc_atingimento
FROM vendas_mensais v
JOIN metas_mensais m ON v.mes = m.mes
ORDER BY v.mes_ano;
