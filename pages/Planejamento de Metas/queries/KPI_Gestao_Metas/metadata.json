{
  "gitSyncId": "68750378005e0954974296b0_07ce569a-12a5-422f-8242-65d91024efc9",
  "id": "Planejamento de Metas_KPI_Gestao_Metas",
  "pluginId": "postgres-plugin",
  "pluginType": "DB",
  "unpublishedAction": {
    "actionConfiguration": {
      "body": "WITH vendas_ano AS (\n  SELECT\n    -- Faturamento Líquido (vendas + devoluções)\n    (\n      COALESCE(SUM(CASE WHEN oper = 'S - Venda' THEN valor_liquido ELSE 0 END), 0)\n      + \n      COALESCE(SUM(CASE WHEN oper = 'DS - Devolução de Venda' THEN valor_liquido ELSE 0 END), 0)\n    ) AS faturamento_liquido_acumulado_ano,\n\n    COALESCE(SUM(CASE WHEN oper = 'S - Venda' THEN valor_liquido ELSE 0 END), 0) AS valor_vendas,\n    COUNT(DISTINCT CASE WHEN oper = 'S - Venda' THEN id_venda END) AS qtd_vendas,\n    COALESCE(SUM(CASE WHEN oper = 'S - Venda' THEN qtde_item ELSE 0 END), 0) AS qtde_itens_vendas,\n    COALESCE(SUM(CASE WHEN oper = 'DS - Devolução de Venda' THEN valor_liquido ELSE 0 END), 0) AS valor_devolucoes,\n    COUNT(DISTINCT CASE WHEN oper = 'DS - Devolução de Venda' THEN id_venda END) AS qtd_devolucoes,\n    COALESCE(SUM(CASE WHEN oper = 'DS - Devolução de Venda' THEN qtde_item ELSE 0 END), 0) AS qtde_itens_devolucao,\n\n    -- Ticket Médio (TM) - CORRIGIDO COM CAST\n    CASE WHEN COUNT(DISTINCT CASE WHEN oper = 'S - Venda' THEN id_venda END) > 0\n      THEN (\n        COALESCE(SUM(CASE WHEN oper = 'S - Venda' THEN valor_liquido ELSE 0 END), 0)::numeric /\n        COUNT(DISTINCT CASE WHEN oper = 'S - Venda' THEN id_venda END)::numeric)\n      ELSE 0 END AS ticket_medio,\n\n    -- Peças por atendimento (PA) - CORRIGIDO COM CAST\n    CASE WHEN COUNT(DISTINCT CASE WHEN oper = 'S - Venda' THEN id_venda END) > 0\n      THEN (\n        SUM(CASE WHEN oper = 'S - Venda' THEN qtde_item ELSE 0 END)::numeric /\n        COUNT(DISTINCT CASE WHEN oper = 'S - Venda' THEN id_venda END)::numeric)\n      ELSE 0 END AS pa,\n\n    -- Preço Médio (PM) - CORRIGIDO COM CAST\n    CASE WHEN SUM(CASE WHEN oper = 'S - Venda' THEN qtde_item ELSE 0 END) > 0\n      THEN (\n        SUM(CASE WHEN oper = 'S - Venda' THEN valor_liquido ELSE 0 END)::numeric /\n        SUM(CASE WHEN oper = 'S - Venda' THEN qtde_item ELSE 0 END)::numeric)\n      ELSE 0 END AS pm,\n\n    -- Índice de devolução (%) - CORRIGIDO COM CAST\n    CASE WHEN SUM(CASE WHEN oper = 'S - Venda' THEN qtde_item ELSE 0 END) > 0\n      THEN (\n        SUM(CASE WHEN oper = 'DS - Devolução de Venda' THEN qtde_item ELSE 0 END)::numeric * 100 /\n        SUM(CASE WHEN oper = 'S - Venda' THEN qtde_item ELSE 0 END)::numeric)\n      ELSE 0 END AS indice_devolucao,\n\n    -- Quantidade de clientes diferentes\n    COUNT(DISTINCT CASE WHEN oper = 'S - Venda' THEN codi_clie END) AS clientes_diferentes\n\n  FROM public.vw_resumo_vend_devo\n  WHERE data_lanca >= '{{ moment().startOf(\"year\").format(\"YYYY-MM-DD\") }}'\n    AND data_lanca <= '{{ moment().format(\"YYYY-MM-DD\") }}'\n    AND ponto_venda = ANY ({{ Select_Lojas.selectedOptionValues }})\n),\n\nmetas_ano AS (\n  SELECT\n    COALESCE(SUM(meta_valor),0) AS meta_acumulada\n  FROM public.vw_metas_vendas_completo\n  WHERE ano = EXTRACT(YEAR FROM CURRENT_DATE)\n    AND nome_loja = ANY ({{ Select_Lojas.selectedOptionValues }})\n)\n\nSELECT\n  v.faturamento_liquido_acumulado_ano,\n  v.valor_vendas,\n  v.qtd_vendas,\n  v.qtde_itens_vendas,\n  v.valor_devolucoes,\n  v.qtd_devolucoes,\n  v.qtde_itens_devolucao,\n  ROUND(v.ticket_medio, 2) as ticket_medio,\n  ROUND(v.pa, 2) as pa,\n  ROUND(v.pm, 2) as pm,\n  ROUND(v.indice_devolucao, 2) as indice_devolucao,\n  v.clientes_diferentes,\n  m.meta_acumulada,\n\n  -- Percentual de atingimento acumulado - CORRIGIDO COM CAST\n  CASE WHEN m.meta_acumulada > 0\n    THEN ROUND((100 * v.faturamento_liquido_acumulado_ano / m.meta_acumulada)::numeric, 2)\n    ELSE 0 END AS perc_atingimento_acumulado\n\nFROM vendas_ano v, metas_ano m\n",
      "encodeParamsToggle": true,
      "paginationType": "NONE",
      "pluginSpecifiedTemplates": [
        {
          "value": true
        }
      ],
      "timeoutInMillisecond": 10000
    },
    "confirmBeforeExecute": false,
    "datasource": {
      "id": "BD DUAS",
      "isAutoGenerated": false,
      "name": "BD DUAS",
      "pluginId": "postgres-plugin"
    },
    "dynamicBindingPathList": [
      {
        "key": "body"
      }
    ],
    "name": "KPI_Gestao_Metas",
    "pageId": "Planejamento de Metas",
    "runBehaviour": "ON_PAGE_LOAD",
    "userSetOnLoad": false
  }
}