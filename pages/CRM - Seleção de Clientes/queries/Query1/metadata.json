{
  "gitSyncId": "68750378005e0954974296b0_5c5d0501-3045-49bc-a457-5a5dc39fee70",
  "id": "CRM - Seleção de Clientes_Query1",
  "pluginId": "postgres-plugin",
  "pluginType": "DB",
  "unpublishedAction": {
    "actionConfiguration": {
      "body": "SELECT DISTINCT\n    c.codigo_do_cliente,\n    c.nome_razao_social,\n    c.email,\n    c.telefone_celular,\n\t\tc.telefone_principal,\n\t\tc.data_cadastro,\n    MAX(hv.data_venda) as ultima_compra,\n    COUNT(DISTINCT hv.id_venda) as total_compras,\n    SUM(hv.valor_total) as valor_total_gasto,\n    STRING_AGG(DISTINCT p.nome_produto, ', ') as produtos_comprados,\n    STRING_AGG(DISTINCT p.categoria, ', ') as categorias_compradas,\n    -- Verificar se já está em alguma campanha ativa\n    CASE \n        WHEN EXISTS (\n            SELECT 1 FROM crm.contatos_campanha cc2 \n            JOIN crm.campanhas camp2 ON cc2.id_campanha = camp2.id_campanha \n            WHERE cc2.id_cliente = c.id_cliente \n            AND camp2.status_campanha = 'Ativa'\n        ) THEN 'Em Campanha Ativa'\n        ELSE 'Disponível'\n    END as status_campanha_atual\nFROM oltp.tb_cliente c\nJOIN historico_vendas hv ON c.id_cliente = hv.id_cliente\nJOIN produtos p ON hv.id_produto = p.id_produto\nWHERE 1=1\n    -- Filtros dinâmicos (deixe em branco por enquanto)\n    AND ({{categoria_filtro}} = '' OR p.categoria = {{categoria_filtro}})\n    AND ({{produto_filtro}} = '' OR p.nome_produto ILIKE '%' || {{produto_filtro}} || '%')\n    AND ({{data_inicio_filtro}} IS NULL OR hv.data_venda >= {{data_inicio_filtro}})\n    AND ({{data_fim_filtro}} IS NULL OR hv.data_venda <= {{data_fim_filtro}})\n    AND c.telefone IS NOT NULL -- Garantir que tem WhatsApp\n    AND c.telefone != ''\nGROUP BY c.id_cliente, c.nome_cliente, c.email, c.telefone\nORDER BY valor_total_gasto DESC, ultima_compra DESC\nLIMIT 1000;",
      "encodeParamsToggle": true,
      "paginationType": "NONE",
      "pluginSpecifiedTemplates": [
        {
          "value": true
        }
      ],
      "timeoutInMillisecond": 10000
    },
    "confirmBeforeExecute": false,
    "datasource": {
      "id": "BD DUAS",
      "isAutoGenerated": false,
      "name": "BD DUAS",
      "pluginId": "postgres-plugin"
    },
    "dynamicBindingPathList": [
      {
        "key": "body"
      }
    ],
    "name": "Query1",
    "pageId": "CRM - Seleção de Clientes",
    "runBehaviour": "MANUAL",
    "userSetOnLoad": false
  }
}